/**
 * Created by zacharysmith on 11/12/15.
 */
var Joi = require('joi');
var _ = require('lodash');
var assert = require('assert');
var Sequelize = require('sequelize');

module.exports = function () {

  return {
    generateJoiReadModel:function(model){
      var readModelBase = {};

      //console.log(model.tableAttributes);

      for(var attributeName in model.tableAttributes){
        var attribute = model.tableAttributes[attributeName];

        if(attribute.readModel){
          readModelBase[attributeName] = attribute.readModel;
        }else if(attribute.allowOnRead !== false && attribute.exclude !== true){
          var attributeReadModel = this.generateJoiModelFromAttribute(attribute);

          if(attribute.requireOnRead === true){
            attributeReadModel = attributeReadModel.required();
          }else{
            attributeReadModel = attributeReadModel.optional();
          }

          readModelBase[attributeName] = attributeReadModel;
        }
      }

      if(model.routeOptions && model.routeOptions.associations){
        for(var associationName in model.routeOptions.associations){
          var association = model.routeOptions.associations[associationName];

          if(association.type == "MANY"){
            readModelBase[associationName] = Joi.array().items(Joi.object().unknown()).optional();
          }else{
            readModelBase[associationName] = Joi.object().unknown().allow(null).optional();
          }
        }
      }

      if(model.extraReadModelAttributes){
        _.extend(readModelBase, model.extraReadModelAttributes);
      }

      var readModel = Joi.object(readModelBase).meta({
        className: model.getTableName() + "ReadModel"
      });

      return readModel;
    },
    generateJoiUpdateModel:function(model){
      var updateModelBase = {};

      for(var attributeName in model.tableAttributes){
        var attribute = model.tableAttributes[attributeName];

        if(attribute.updateModel){
          updateModelBase[attributeName] = attribute.updateModel;
        }else if(!attribute.primaryKey && attribute.allowOnUpdate !== false){
          var attributeUpdateModel = this.generateJoiModelFromAttribute(attribute);

          if(attribute.requireOnUpdate === true){
            attributeUpdateModel = attributeUpdateModel.required();
          }else{
            attributeUpdateModel = attributeUpdateModel.optional();
          }

          updateModelBase[attributeName] = attributeUpdateModel;
        }
      }

      if(model.extraUpdateModelAttributes){
        _.extend(updateModelBase, model.extraUpdateModelAttributes);
      }

      var updateModel = Joi.object(updateModelBase).meta({
        className: model.getTableName() + "UpdateModel"
      }).optional();

      return updateModel;
    },
    generateJoiCreateModel:function(model){
      var createModelBase = {};

      for(var attributeName in model.tableAttributes){

        var attribute = model.tableAttributes[attributeName];

        if(attribute.createModel){
          createModelBase[attributeName] = attribute.createModel;
        }else if(!attribute.primaryKey && attribute.allowOnCreate !== false){
          var attributeCreateModel = this.generateJoiModelFromAttribute(attribute);

          if((attribute.allowNull === false && !attribute.defaultValue && !attribute._autoGenerated) || attribute.requireOnCreate === true){
            //console.log("required: ", attributeName);

            //console.log(attribute);

            attributeCreateModel = attributeCreateModel.required();
          }else{
            //console.log("optional: ", attributeName);

            attributeCreateModel = attributeCreateModel.optional();
          }

          createModelBase[attributeName] = attributeCreateModel;
        }
      }

      if(model.extraCreateModelAttributes){
        _.extend(createModelBase, model.extraCreateModelAttributes);
      }

      var createModel = Joi.object(createModelBase).meta({
        className: model.getTableName() + "CreateModel"
      });

      return createModel;
    },
    generateJoiModelFromAttribute:function(attribute){
      var model;

      switch(attribute.typeKey){
        case Sequelize.UUID.key:
          model = Joi.string().guid();
          break;
        case Sequelize.BOOLEAN.key:
          model = Joi.bool();
          break;
        case Sequelize.DECIMAL.key:
          model = Joi.number();
          break;
        case Sequelize.INTEGER.key:
          model = Joi.number().integer();
          break;
        case Sequelize.DATE.key:
          model = Joi.date();
          break;
        case Sequelize.ENUM.key:
          model = Joi.string().valid(attribute.values);
          break;
        default:
          model = Joi.string();

          if(!attribute.notEmpty){
            model = model.allow('');
          }

          break;
      }

      if(attribute.allowNull){
        model = model.allow(null);
      }

      return model;
    }
  }
};